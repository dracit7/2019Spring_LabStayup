
## Operating System

### Introduction

正如你们在Shell题题目中所了解的那样，zhz同学的服务器集群遭受到了心怀不轨的lyj所派出的黑客的攻击。虽然及时剪断了网线并重装了系统，但在这个过程中的一些误操作导致了zhz工作进度的丢失。懒惰的zhz并不想自己重新完成一遍丢失掉的函数实现，于是他把这个工作交给了你。

如你所见，这是一个名为`Unique OS`的操作系统。你可以认为系统的绝大部分功能都已经实现完毕，但有一些函数的某些部分丢失掉了。你的任务就是补全这些不完整的函数实现，让系统能够正常运行。

### Goal

> #### Part 1 IO functions

你需要补全`lib/print.c`中的`fprintfmt`函数的实现，以使其支持`%x`，`%f`，`%s`三种 __变量类型的输出__ 。你可以使用`lib/print.h`和`sys/io.h`中定义的函数，但不能使用系统库中的函数。

这一部分是其余部分的基础，因此请优先完成这一部分任务。在你完成了你的代码之后，你可以在题目文件夹内执行`make testIO`来测试你的解答是否正确。

如果你通过`make testIO`的检查确定你已经正确地实现了`fprintfmt`函数，你就可以开始试着完成其他部分的任务。

__ADVANCED__：请实现其他的C语言转义字符识别。

> #### Part 2 Shutdown

你需要为操作系统终端添加一个新的命令`shutdown`。这个命令应当调用`sys/err.h`中的`shutdown`函数来退出系统。为此，你可以在`lib/command.h`中添加你的函数声明，并在`lib/command.c`中完成对应的函数实现。

为了完成这个任务，请仔细观察`command.h`与`command.c`的内容。它们会非常有帮助。

在题目文件夹内执行`make console`可以编译出并进入`Unique OS`的终端。你可以在终端中测试你的指令能否正常工作。

> #### Part 3 The Stack

你需要完善`lib/command.c`中的`console_backtrace`函数的实现，以使其能够打印出当前 __程序栈的内存结构__ 。为了完成这个任务，你需要了解 __C语言程序栈的结构__ 和 __栈指针寄存器的作用__ 。由于本题目运行环境是64位系统，你可以假定栈中的每个单元大小为 __8个字节__ 。

在开始完成这个函数之前，你需要像第二部分所做的那样让操作系统支持`backtrace`命令。这样，就可以在终端中执行`backtrace`指令来观察`console_backtrace`函数的行为，这会对你的工作有所帮助。

`backtrace`指令的输出格式应该是这样的：

```c
Stack backtrace:
  Present function:
    frame pointer:  0x23333333
    return address: 0x23333333
  Backtrace 1:
    frame pointer:  0x23333333
    return address: 0x23333333
  Backtrace 2:
    frame pointer:  0x23333333
    return address: 0x23333333
  // More backtraces...(这一行不用显示)
Backtrace finished.
```

其中`frame pointer`是指 __栈帧头指针的值__ ，`return address`是指 __函数的返回地址__。请自行思考和查阅如何获得这些值。

如果函数功能正确，`backtrace`指令应该会输出三个栈帧的结构，且它们的返回地址分别是`0x70100053`，`0x701000CE`和`0x7010010F`。(由于栈随机化的影响，`frame pointer`的值并不是确定的，但其长度一定是八个16进制数。)

- 提示：
    + 请灵活运用 __指针值__ 和 __整型值__ 之间的 __显式类型转换__ 。
    + 由于是64位机，无论是栈单元还是栈指针所占的内存空间都是 __8个字节__ ，__请合理选用显式类型转换所使用的数据类型__。

__ADVANCED__：请进一步解析栈帧，输出每次函数调用的 __实参值__ 。每次函数调用都有四个实参，你需要用`%d`的格式将它们打印出来。

> #### Part 4 And more

~~如果上面三个部分还无法满足你的话，你可以向监考官请求第四部分试题~~

### Restrictions

在完成本题的过程中，请严格遵守以下规定：

- 使用 __纯C语言__ 编程，且 __只允许使用本题目的文件夹下给出的库__ 。如果违反这一条规定，本题视为不得分。
- __严禁任何形式的抄袭__。
- __请不要修改任何题目要求范围外的代码__。也就是说，你只需要在题目要求的位置(大多数标记有`Your code here`注释)编程，而不需要更改任何其他位置的代码。

### Hints

- 本题目在`64位Linux系统`，`gcc 8.2.1`版本下编译通过。如果编译出现问题，请检查你的系统是否为Linux，以及你的gcc版本是否为最新版本。如果检查后仍然出现问题，请从速联系监考人员。
- Feel free to [Google](https://www.google.com).
- Make use of `man page`.